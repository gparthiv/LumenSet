<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FIBO DataForge - Synthetic Dataset Generator</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <h1 class="logo">ğŸ“¦ FIBO DataForge</h1>
      <p class="tagline">Structured Synthetic Dataset Generator</p>
      <p class="sub-tagline">Powered by Bria FIBO AI - Generate ML-ready datasets in minutes</p>
    </div>
  </header>

  <!-- Value Propositions -->
  <div class="container">
    <div class="value-props">
      <div class="prop">
        <span class="prop-icon">âš¡</span>
        <strong>Lightning Fast</strong>
        <small>10-15 sec per image</small>
      </div>
      <div class="prop">
        <span class="prop-icon">ğŸ¯</span>
        <strong>100% Reproducible</strong>
        <small>Seed + JSON = Identical output</small>
      </div>
      <div class="prop">
        <span class="prop-icon">ğŸ“Š</span>
        <strong>Full Metadata</strong>
        <small>Complete documentation</small>
      </div>
      <div class="prop">
        <span class="prop-icon">ğŸ¤–</span>
        <strong>ML-Ready</strong>
        <small>Perfect for training</small>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container">
    <!-- Step 2: Object Description -->
    <section class="card" id="object-section" style="display: none;">
      <h2>ğŸ“ Step 1: Describe Your Object</h2>

      <div class="tabs">
        <button class="tab active" onclick="switchInputMode('text')">Text Description</button>
        <button class="tab" onclick="switchInputMode('image')">Reference Image</button>
      </div>

      <div id="text-input-mode" class="input-mode">
        <div class="form-group">
          <label for="object-description">Object Description:</label>
          <input type="text" id="object-description"
            placeholder="e.g., industrial bolt with threading, agricultural tomato, robotic gripper component" value="">
          <small>ğŸ’¡ Tip: Be specific for better results (materials, colors, textures)</small>
        </div>
      </div>

      <div id="image-input-mode" class="input-mode" style="display: none;">
        <div class="form-group">
          <label>Upload Reference Image:</label>
          <!-- fixed stray extra > -->
          <input type="file" id="reference-image" accept="image/*" onchange="previewReferenceImage(event)">
          <div id="image-preview" class="image-preview-container"></div>
          <small>âœ¨ For maximum consistency: Upload clear, well-lit reference photo</small>
        </div>
        <div class="form-group">
          <label for="image-context">Detailed Description (Character Bible):</label>
          <textarea id="image-context" rows="4"
            placeholder="Describe key features: dimensions, materials, textures, colors, unique characteristics. More detail = better consistency across angles."></textarea>
          <small>ğŸ’¡ Example: "Red tomato, 7cm diameter, smooth skin with slight green stem, minor natural
            blemishes"</small>
        </div>
      </div>

      <button class="btn btn-primary" onclick="generateBasePrompt()">
        Generate Base Structure â†’
      </button>
      <div id="base-generation-status"></div>
    </section>

    <!-- Step 3: Parameter Controls -->
    <section class="card" id="parameters-section" style="display: none;">
      <div class="dataset-size-selector">
        <h3>ğŸ“Š Dataset Size</h3>
        <div class="size-options">
          <!-- data-size attributes added for programmatic wiring -->
          <button class="size-btn active" data-size="quick" onclick="setDatasetSize('quick', event)">
            <span class="size-label">Quick Test</span>
            <span class="size-number">4-8 images</span>
            <small>~2-4 minutes</small>
          </button>

          <button class="size-btn" data-size="standard" onclick="setDatasetSize('standard', event)">
            <span class="size-label">Standard</span>
            <span class="size-number">16-24 images</span>
            <small>~8-12 minutes</small>
          </button>

          <button class="size-btn" data-size="medium" onclick="setDatasetSize('medium', event)">
            <span class="size-label">Medium</span>
            <span class="size-number">32-48 images</span>
            <small>~16-24 minutes</small>
          </button>

          <button class="size-btn" data-size="large" onclick="setDatasetSize('large', event)">
            <span class="size-label">Large ML Dataset</span>
            <span class="size-number">64-96 images</span>
            <small>~32-48 minutes</small>
          </button>
        </div>

        <div class="dataset-recommendation">
          <strong>ğŸ’¡ Recommendation:</strong> <span id="size-recommendation">Quick Test for initial validation</span>
        </div>
      </div>

      <h2>ğŸ›ï¸ Step 2: Define Dataset Parameters</h2>

      <div class="preset-selector">
        <label>Quick Presets:</label>
        <select id="preset-select" onchange="applyPreset()">
          <option value="">Custom Configuration</option>
          <option value="product_photography">Product Photography (4 angles)</option>
          <option value="lighting_study">Lighting Study (4 directions)</option>
          <option value="multi_angle">Multi-Angle Dataset (4 views)</option>
        </select>
      </div>

      <div class="parameters-grid">
        <!-- Camera Parameters -->
        <div class="camera-control-panel">
          <h3 style="font-size: 50px;">ğŸ“· Camera Controls</h3>

          <!-- Rotation Control -->
          <div class="camera-slider-group">
            <label>
              <span class="slider-label">ğŸ”„ Rotation (Left â† â†’ Right)</span>
              <span class="slider-value" id="rotation-value">0Â°</span>
            </label>
            <input type="range" id="rotation-slider" min="-90" max="90" value="0" step="45"
              oninput="updateRotationValue(this.value)">
            <div class="slider-markers">
              <span>-90Â°</span>
              <span>-45Â°</span>
              <span>0Â°</span>
              <span>45Â°</span>
              <span>90Â°</span>
            </div>
            <small>Controls horizontal rotation around object</small>
          </div>

          <!-- Tilt Control -->
          <div class="camera-slider-group">
            <label>
              <span class="slider-label">ğŸ“ Tilt (Up â†‘ â†“ Down)</span>
              <span class="slider-value" id="tilt-value">0Â°</span>
            </label>
            <input type="range" id="tilt-slider" min="-45" max="45" value="0" step="45"
              oninput="updateTiltValue(this.value)">
            <div class="slider-markers">
              <span>-45Â° (Up)</span>
              <span>0Â° (Level)</span>
              <span>45Â° (Down)</span>
            </div>
            <small>Controls vertical camera angle</small>
          </div>

          <!-- Zoom Control -->
          <div class="camera-slider-group">
            <label>
              <span class="slider-label">ğŸ” Zoom (Distance)</span>
              <span class="slider-value" id="zoom-value">5</span>
            </label>
            <input type="range" id="zoom-slider" min="0" max="10" value="5" step="5"
              oninput="updateZoomValue(this.value)">
            <div class="slider-markers">
              <span>0 (Close)</span>
              <span>5 (Mid)</span>
              <span>10 (Far)</span>
            </div>
            <small>Controls camera distance from subject</small>
          </div>

          <!-- Multi-Angle Sweep Generator -->
          <div class="angle-sweep-section">
            <h4>ğŸ”„ Generate Multi-Angle Sweep</h4>
            <p class="sweep-description">Automatically generate images across all rotation/tilt combinations</p>

            <div class="sweep-options">
              <label>
                <input type="checkbox" id="enable-rotation-sweep" checked>
                <strong>Rotation Sweep</strong> (5 angles: -90Â° to 90Â°)
              </label>
              <label>
                <input type="checkbox" id="enable-tilt-sweep">
                <strong>Tilt Sweep</strong> (3 angles: -45Â°, 0Â°, 45Â°)
              </label>
              <label>
                <input type="checkbox" id="enable-zoom-sweep">
                <strong>Zoom Sweep</strong> (3 distances: close, mid, far)
              </label>
            </div>

            <div class="sweep-summary">
              <p>Total angles: <strong id="angle-sweep-count">5</strong> images</p>
              <small id="angle-sweep-detail">Rotation: 5 angles Ã— Lighting: 1 = 5 variations</small>
            </div>
          </div>

          <!-- 3D Preview (Simple Visualization) -->
          <div class="camera-preview-3d">
            <h4>ğŸ“¸ Camera Position Preview</h4>
            <div class="preview-container">
              <div class="preview-object" id="preview-object">
                <div class="object-cube"></div>
              </div>
              <div class="camera-indicator" id="camera-indicator">ğŸ“·</div>
            </div>
            <p class="preview-label">
              Position: <span id="preview-position">Front, Eye-Level, Mid-Distance</span>
            </p>
          </div>
        </div>

        <!-- Lighting Controls (Simplified) -->
        <div class="lighting-control-panel">
          <h3>ğŸ’¡ Lighting Directions</h3>
          <p class="control-description">Select one or multiple lighting directions for your dataset</p>

          <!-- WRAPPER: lighting-presets is kept for UI, but we also provide an id="lighting-directions" for scripts -->
          <div id="lighting-directions">
            <div class="lighting-presets">
              <label>
                <input type="checkbox" name="lighting" value="front-lit" checked onchange="updateAngleSweepCount()">
                <span class="preset-card">
                  <span class="preset-icon">â˜€ï¸</span>
                  <strong>Front Light</strong>
                  <small>Even illumination</small>
                </span>
              </label>

              <label>
                <input type="checkbox" name="lighting" value="side-lit" onchange="updateAngleSweepCount()">
                <span class="preset-card">
                  <span class="preset-icon">ğŸŒ“</span>
                  <strong>Side Light</strong>
                  <small>Dramatic shadows</small>
                </span>
              </label>

              <label>
                <input type="checkbox" name="lighting" value="back-lit" onchange="updateAngleSweepCount()">
                <span class="preset-card">
                  <span class="preset-icon">ğŸŒ…</span>
                  <strong>Back Light</strong>
                  <small>Rim lighting</small>
                </span>
              </label>

              <label>
                <input type="checkbox" name="lighting" value="top-lit" onchange="updateAngleSweepCount()">
                <span class="preset-card">
                  <span class="preset-icon">ğŸ’¡</span>
                  <strong>Top Light</strong>
                  <small>Overhead</small>
                </span>
              </label>
            </div>
          </div>

          <div class="lighting-summary">
            <p>Selected: <strong id="lighting-count">1</strong> lighting direction(s)</p>
          </div>
        </div>

        <!-- Background Parameters -->
        <div class="parameters-row">
          <div class="param-group">
            <h3>ğŸ¨ Background</h3>
            <div class="radio-group" id="backgrounds">
              <label><input type="radio" name="background" value="white-studio" checked> White Studio</label>
              <label><input type="radio" name="background" value="black-studio"> Black Studio</label>
              <label><input type="radio" name="background" value="wooden-surface"> Wooden Surface</label>
              <label><input type="radio" name="background" value="fabric-texture"> Fabric</label>
            </div>
          </div>

          <!-- Focal Length -->
          <div class="param-group">
            <h3>ğŸ” Focal Length</h3>
            <div class="radio-group" id="focal-lengths">
              <label><input type="radio" name="focal-length" value="wide-angle"> Wide (24mm)</label>
              <label><input type="radio" name="focal-length" value="standard" checked> Standard (50mm)</label>
              <label><input type="radio" name="focal-length" value="portrait"> Portrait (85mm)</label>
              <label><input type="radio" name="focal-length" value="telephoto"> Telephoto (135mm)</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Parameters Accordion -->
      <div class="advanced-params-section">
        <button class="accordion-toggle" onclick="toggleAdvancedParams()">
          âš™ï¸ Advanced Parameters (Optional)
          <span class="toggle-icon">â–¼</span>
        </button>

        <div id="advanced-params-content" class="accordion-content" style="display: none;">
          <!-- (same advanced params markup â€” unchanged) -->
          <!-- Color Control -->
          <div class="param-group">
            <h3>ğŸ¨ Color Control</h3>
            <label>
              <input type="checkbox" id="use-exact-colors">
              Use Exact Colors (Hex)
            </label>
            <div id="color-inputs" style="display: none; margin-top: 10px;">
              <div class="color-input-row">
                <label>Background Color:</label>
                <input type="color" id="bg-color" value="#FFFFFF">
                <input type="text" id="bg-color-hex" value="#FFFFFF" placeholder="#FFFFFF">
              </div>
              <div class="color-input-row">
                <label>Surface Color:</label>
                <input type="color" id="surface-color" value="#8B7355">
                <input type="text" id="surface-color-hex" value="#8B7355" placeholder="#8B7355">
              </div>
            </div>
          </div>

          <!-- Surface & Material -->
          <div class="param-group">
            <h3>ğŸªµ Surface & Material</h3>
            <div class="form-group">
              <label>Surface Finish:</label>
              <select id="surface-finish">
                <option value="matte">Matte</option>
                <option value="glossy">Glossy</option>
                <option value="satin">Satin</option>
                <option value="unglazed">Unglazed</option>
              </select>
            </div>
            <div class="form-group">
              <label>Surface Tone:</label>
              <select id="surface-tone">
                <option value="neutral">Neutral</option>
                <option value="warm">Warm</option>
                <option value="cool">Cool</option>
                <option value="dark">Dark</option>
              </select>
            </div>
          </div>

          <!-- Lighting Detail -->
          <div class="param-group">
            <h3>ğŸ’¡ Lighting Detail</h3>
            <div class="form-group">
              <label>Contrast:</label>
              <select id="lighting-contrast">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="form-group">
              <label>Shadow Behavior:</label>
              <select id="shadow-behavior">
                <option value="soft edge" selected>Soft Edge</option>
                <option value="hard edge">Hard Edge</option>
                <option value="minimal">Minimal</option>
              </select>
            </div>
            <div class="form-group">
              <label>Color Temperature:</label>
              <select id="color-temperature">
                <option value="neutral-warm" selected>Neutral Warm</option>
                <option value="neutral-cool">Neutral Cool</option>
                <option value="warm">Warm</option>
                <option value="cool">Cool</option>
              </select>
            </div>
          </div>

          <!-- Camera Technical -->
          <div class="param-group">
            <h3>ğŸ“· Camera Technical</h3>
            <div class="form-group">
              <label>Aperture (f-stop):</label>
              <select id="aperture">
                <option value="1.4">f/1.4 (Very Shallow)</option>
                <option value="2.8">f/2.8 (Shallow)</option>
                <option value="4.5" selected>f/4.5 (Medium)</option>
                <option value="8">f/8 (Deep)</option>
                <option value="16">f/16 (Very Deep)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Distance:</label>
              <select id="camera-distance">
                <option value="close">Close-up</option>
                <option value="mid" selected>Mid-distance</option>
                <option value="far">Far</option>
              </select>
            </div>
          </div>

          <!-- Composition -->
          <div class="param-group">
            <h3>ğŸ“ Composition</h3>
            <div class="form-group">
              <label>Negative Space:</label>
              <select id="negative-space">
                <option value="minimal">Minimal</option>
                <option value="medium" selected>Medium</option>
                <option value="generous">Generous</option>
              </select>
            </div>
            <div class="form-group">
              <label>Camera Height:</label>
              <select id="camera-height-detail">
                <option value="low">Low (Below Subject)</option>
                <option value="eye-level" selected>Eye-Level</option>
                <option value="high">High (Above Subject)</option>
              </select>
            </div>
          </div>

          <!-- Realism & Imperfections -->
          <div class="param-group">
            <h3>âœ¨ Realism & Detail</h3>
            <label>
              <input type="checkbox" id="add-imperfections" checked>
              Add Realistic Imperfections
            </label>
            <div id="imperfection-types" style="margin-top: 10px;">
              <label><input type="checkbox" value="fingerprints" checked> Fingerprints</label>
              <label><input type="checkbox" value="tool marks" checked> Tool Marks</label>
              <label><input type="checkbox" value="uneven edges" checked> Uneven Edges</label>
              <label><input type="checkbox" value="slight scratches"> Slight Scratches</label>
              <label><input type="checkbox" value="patina"> Patina/Age Marks</label>
            </div>
          </div>

          <!-- Mood -->
          <div class="param-group">
            <h3>ğŸ­ Mood</h3>
            <div class="checkbox-group" id="mood-options">
              <label><input type="checkbox" value="calm"> Calm</label>
              <label><input type="checkbox" value="luxurious"> Luxurious</label>
              <label><input type="checkbox" value="dramatic"> Dramatic</label>
              <label><input type="checkbox" value="playful"> Playful</label>
              <label><input type="checkbox" value="professional"> Professional</label>
              <label><input type="checkbox" value="cozy"> Cozy</label>
            </div>
          </div>
        </div>
      </div>

      <div class="generation-summary">
        <p>Dataset will contain: <strong id="total-variations">0</strong> variations</p>
        <p>Estimated time: <strong id="estimated-time">0</strong> minutes</p>
      </div>

      <button class="btn btn-success btn-large" onclick="startDatasetGeneration()">
        ğŸš€ Generate Dataset
      </button>
    </section>

    <!-- Step 4: Generation Progress -->
    <section class="card" id="progress-section" style="display: none;">
      <h2>â³ Generating Dataset...</h2>

      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <p class="progress-text" id="progress-text">Initializing...</p>

      <div class="current-variation" id="current-variation"></div>
    </section>

    <!-- Step 5: Results Gallery -->
    <section class="card" id="results-section" style="display: none;">
      <h2>âœ… Dataset Complete!</h2>

      <div class="results-actions">
        <button class="btn btn-success" onclick="downloadDataset()">
          ğŸ“¥ Download Dataset (ZIP)
        </button>
        <button class="btn btn-secondary" onclick="viewMetadata()">
          ğŸ“Š View All Metadata
        </button>
        <button class="btn btn-secondary" onclick="startOver()">
          ğŸ”„ Generate Another Dataset
        </button>
      </div>

      <div class="gallery" id="results-gallery"></div>
    </section>

    <!-- Metadata Viewer Modal -->
    <div id="metadata-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close" onclick="closeMetadataModal()">&times;</span>
        <h2>ğŸ“‹ Dataset Metadata</h2>
        <pre id="metadata-viewer"></pre>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p><strong>FIBO DataForge</strong> - Enterprise-Grade Dataset Generation</p>
    <p><small>Powered by Bria FIBO AI | Built for ML Professionals | Â© 2025</small></p>
  </footer>

  <!-- Hidden compatibility block for older functions that reference camera-angles -->
  <!-- This keeps your UI intact but provides the inputs those functions expect -->
  <div id="camera-angles" style="display:none;">
    <label><input type="checkbox" value="eye-level" checked> eye-level</label>
    <label><input type="checkbox" value="high-angle"> high-angle</label>
    <label><input type="checkbox" value="low-angle"> low-angle</label>
    <label><input type="checkbox" value="overhead"> overhead</label>
  </div>

  <!-- Scripts (config first so window.CONFIG exists) -->
  <script src="config.js"></script>
  <script src="api.js"></script>
  <script src="generator.js"></script>
  <script src="exporter.js"></script>

  <script>
    // Global state
    let api = null;
    let baseStructuredPrompt = null;
    let datasetResults = [];
    let referenceImageBase64 = null;
    let currentInputMode = 'text';
    let selectedDatasetSize = 'quick';

    // Preview reference image
    function previewReferenceImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Please upload an image file');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const base64Data = e.target.result;
        referenceImageBase64 = base64Data.split(',')[1];

        const preview = document.getElementById('image-preview');
        preview.innerHTML = `
            <div class="image-preview-container">
                <img src="${base64Data}" class="preview-image" alt="Reference">
                <div class="preview-info">
                    <p><strong>âœ… Image Loaded</strong></p>
                    <p>Size: ${(file.size / 1024).toFixed(2)} KB</p>
                    <p>Type: ${file.type}</p>
                    <small style="color: var(--success);">This image will guide all variations</small>
                </div>
            </div>
        `;
        console.log('Reference image loaded:', referenceImageBase64.substring(0, 50) + '...');
      };
      reader.readAsDataURL(file);
    }

    // DOM ready initialization (single place)
    document.addEventListener('DOMContentLoaded', () => {
      // init API automatically if config provided
      if (window.CONFIG && window.CONFIG.BRIA_API_KEY && !window.CONFIG.BRIA_API_KEY.includes('YOUR_API_KEY')) {
        api = new BriaFIBOAPI(window.CONFIG.BRIA_API_KEY);
        console.log('âœ… API initialized automatically');
        document.getElementById('object-section').style.display = 'block';
      } else {
        console.warn('âš ï¸ BRIA_API_KEY not configured or default placeholder detected.');
        // keep object-section hidden; user can still init manually via UI if you add that later
      }

      // initial preview and counts
      updateCameraPreview();
      updateAngleSweepCount();

      // wire sweep checkboxes
      ['enable-rotation-sweep', 'enable-tilt-sweep', 'enable-zoom-sweep'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', updateAngleSweepCount);
      });

      // sliders
      ['rotation-slider', 'tilt-slider', 'zoom-slider'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', () => {
          updateCameraPreview();
          updateAngleSweepCount();
          // manual change by user should release preset lock (if any)
          // keep selectedDatasetSize but do not force override after manual change
        });
      });

      // lighting checkboxes
      document.querySelectorAll('.lighting-presets input[type="checkbox"], #lighting-directions input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateAngleSweepCount);
      });

      // wire dataset-size buttons programmatically (they already have onclick, but ensure data-size support)
      document.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          // ensure event.target.closest works for nested spans/buttons
          const ds = btn.dataset.size || btn.getAttribute('data-size') || 'quick';
          setDatasetSize(ds, e);
        });
      });

      // wire preset-select
      const presetSelect = document.getElementById('preset-select');
      if (presetSelect) presetSelect.addEventListener('change', applyPreset);

      // HEX color picker toggle
      const uec = document.getElementById('use-exact-colors');
      if (uec) {
        uec.addEventListener('change', () => {
          const colorInputs = document.getElementById('color-inputs');
          if (colorInputs) {
            colorInputs.style.display = uec.checked ? 'block' : 'none';
          }
        });
      }

    });

    // Switch input mode (keeps original behavior)
    function switchInputMode(mode) {
      currentInputMode = mode;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      // event might not be present (call from code), find clicked tab
      const tabs = Array.from(document.querySelectorAll('.tab'));
      const activeTab = mode === 'text' ? tabs[0] : tabs[1];
      if (activeTab) activeTab.classList.add('active');

      document.getElementById('text-input-mode').style.display = mode === 'text' ? 'block' : 'none';
      document.getElementById('image-input-mode').style.display = mode === 'image' ? 'block' : 'none';
    }

    // Generate base structured prompt - keeps existing behavior
    async function generateBasePrompt() {
      if (!api) {
        alert('Please initialize API first');
        return;
      }

      const statusEl = document.getElementById('base-generation-status');
      statusEl.innerHTML = '<div class="loading">Generating structured prompt...</div>';

      try {
        let prompt, images = null;

        if (currentInputMode === 'image') {
          if (!referenceImageBase64) {
            alert('Please upload a reference image first');
            statusEl.innerHTML = '<div class="error">âŒ No reference image uploaded</div>';
            return;
          }

          const context = document.getElementById('image-context').value.trim();
          prompt = context ? `Create variations of this subject maintaining exact visual characteristics. ${context}` :
            'Create variations of this subject, maintaining all visual characteristics, proportions, colors, textures, and identity across different camera angles and lighting conditions.';
          images = [referenceImageBase64];
        } else {
          prompt = document.getElementById('object-description').value.trim();
          if (!prompt) {
            alert('Please enter an object description');
            statusEl.innerHTML = '';
            return;
          }
        }

        const result = await api.generateStructuredPrompt(prompt, images, (attempt, max) => {
          statusEl.innerHTML = `<div class="loading">Processing with ${currentInputMode === 'image' ? 'reference image' : 'text description'}... (${attempt}/${max})</div>`;
        });

        baseStructuredPrompt = result.structured_prompt;
        statusEl.innerHTML = `<div class="success">âœ… Base structure generated from ${currentInputMode === 'image' ? 'reference image' : 'description'}!</div>`;
        console.log('Structured prompt generated:', result);

        setTimeout(() => {
          document.getElementById('parameters-section').style.display = 'block';
          document.getElementById('parameters-section').scrollIntoView({ behavior: 'smooth' });
          updateAngleSweepCount();
        }, 250);

      } catch (error) {
        console.error('Generation error:', error);
        statusEl.innerHTML = `<div class="error">âŒ Error: ${error.message}</div>`;
      }
    }

    // Update camera preview (unchanged)
    function updateCameraPreview() {
      const rotation = parseInt(document.getElementById('rotation-slider').value);
      const tilt = parseInt(document.getElementById('tilt-slider').value);
      const zoom = parseInt(document.getElementById('zoom-slider').value);

      const object = document.getElementById('preview-object');
      if (object) object.style.transform = `rotateY(${rotation}deg) rotateX(${-tilt}deg)`;

      const camera = document.getElementById('camera-indicator');
      if (camera) {
        const radius = 60 + (zoom * 5);
        const angleRad = (rotation * Math.PI) / 180;
        const tiltRad = (tilt * Math.PI) / 180;
        const x = 50 + Math.sin(angleRad) * radius;
        const y = 50 + Math.sin(tiltRad) * 30;
        camera.style.left = x + '%';
        camera.style.top = y + '%';
      }

      const rotationLabel = rotation < -30 ? 'Left' : rotation > 30 ? 'Right' : 'Front';
      const tiltLabel = tilt < -15 ? 'High' : tilt > 15 ? 'Low' : 'Eye-Level';
      const zoomLabel = zoom === 0 ? 'Close' : zoom === 5 ? 'Mid-Distance' : 'Far';
      const previewLabelEl = document.getElementById('preview-position');
      if (previewLabelEl) previewLabelEl.textContent = `${rotationLabel}, ${tiltLabel}, ${zoomLabel}`;
    }

    // Angle sweep & count logic (keeps same behavior but robust to missing nodes)
    function updateAngleSweepCount() {
      const rotationSweep = document.getElementById('enable-rotation-sweep')?.checked;
      const tiltSweep = document.getElementById('enable-tilt-sweep')?.checked;
      const zoomSweep = document.getElementById('enable-zoom-sweep')?.checked;

      let count = 1;
      const detail = [];

      if (rotationSweep) { count *= 5; detail.push('Rotation: 5'); } else { detail.push('Rotation: 1'); }
      if (tiltSweep) { count *= 3; detail.push('Tilt: 3'); } else { detail.push('Tilt: 1'); }
      if (zoomSweep) { count *= 3; detail.push('Zoom: 3'); } else { detail.push('Zoom: 1'); }

      const selectedLighting = document.querySelectorAll('.lighting-presets input[type="checkbox"]:checked').length || 1;
      count *= selectedLighting;
      detail.push(`Lighting: ${selectedLighting}`);

      const angleCountEl = document.getElementById('angle-sweep-count');
      const angleDetailEl = document.getElementById('angle-sweep-detail');
      if (angleCountEl) angleCountEl.textContent = count;
      if (angleDetailEl) angleDetailEl.textContent = detail.join(' Ã— ') + ` = ${count} variations`;

      const totalVariationsEl = document.getElementById('total-variations');
      const estimatedTimeEl = document.getElementById('estimated-time');
      if (totalVariationsEl) totalVariationsEl.textContent = count;
      if (estimatedTimeEl) {
        const estimatedMinutes = Math.ceil((count * 15) / 60); // 15s per image
        estimatedTimeEl.textContent = estimatedMinutes;
      }

      updateLightingCount();
    }

    function updateLightingCount() {
      const checkedLighting = document.querySelectorAll('.lighting-presets input[type="checkbox"]:checked').length;
      const lightingCountEl = document.getElementById('lighting-count');
      if (lightingCountEl) {
        lightingCountEl.textContent = checkedLighting || 0;
      }
    }

    // dataset-size behavior: selecting a dataset size forces presets (but manual changes afterwards override)
    function setDatasetSize(size, event) {
      selectedDatasetSize = size;

      // Update button active states
      document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
      // try to find the closest .size-btn from event.target, fallback to matching data-size button
      try {
        if (event && event.target && event.target.closest) {
          const clicked = event.target.closest('.size-btn');
          if (clicked) clicked.classList.add('active');
          else {
            const fallback = document.querySelector(`.size-btn[data-size="${size}"]`);
            if (fallback) fallback.classList.add('active');
          }
        } else {
          const fallback = document.querySelector(`.size-btn[data-size="${size}"]`);
          if (fallback) fallback.classList.add('active');
        }
      } catch (e) {
        const fallback = document.querySelector(`.size-btn[data-size="${size}"]`);
        if (fallback) fallback.classList.add('active');
      }

      const recommendations = {
        'quick': 'Quick Test perfect for validation and demos',
        'standard': 'Standard size good for initial model training',
        'medium': 'Medium dataset suitable for small-scale ML projects',
        'large': 'Large dataset recommended for production ML models (90 images)'
      };
      document.getElementById('size-recommendation').textContent = recommendations[size] || '';

      // Apply preset behaviour per size:
      if (size === 'quick') {
        // Rotation sweep on (5), tilt off, zoom off, keep 1 lighting
        document.getElementById('enable-rotation-sweep').checked = true;
        document.getElementById('enable-tilt-sweep').checked = false;
        document.getElementById('enable-zoom-sweep').checked = false;

        // set sliders to defaults but allow user to change them later
        document.getElementById('rotation-slider').value = 0;
        document.getElementById('tilt-slider').value = 0;
        document.getElementById('zoom-slider').value = 5;

        // enforce only front-lit by default
        document.querySelectorAll('#lighting-directions input[type="checkbox"]').forEach(cb => cb.checked = false);
        const front = document.querySelector('#lighting-directions input[value="front-lit"]');
        if (front) front.checked = true;

      } else if (size === 'standard') {
        // rotation & tilt on, zoom off, 1 lighting
        document.getElementById('enable-rotation-sweep').checked = true;
        document.getElementById('enable-tilt-sweep').checked = true;
        document.getElementById('enable-zoom-sweep').checked = false;

        document.querySelectorAll('#lighting-directions input[type="checkbox"]').forEach(cb => cb.checked = true);

      } else if (size === 'medium') {
        // rotation & tilt on, zoom off, multiple lightings
        document.getElementById('enable-rotation-sweep').checked = true;
        document.getElementById('enable-tilt-sweep').checked = true;
        document.getElementById('enable-zoom-sweep').checked = false;

        // try to select 3 lighting (if available) - pick all
        document.querySelectorAll('#lighting-directions input[type="checkbox"]').forEach(cb => cb.checked = true);

      } else if (size === 'large') {
        // LARGE -> target 90 images: rotation(5) x tilt(3) x zoom(3) x lighting(2) = 90
        document.getElementById('enable-rotation-sweep').checked = true;
        document.getElementById('enable-tilt-sweep').checked = true;
        document.getElementById('enable-zoom-sweep').checked = true;

        // prefer two lighting options: front-lit + side-lit (fallback to whatever exists)
        document.querySelectorAll('#lighting-directions input[type="checkbox"]').forEach(cb => cb.checked = false);
        const prefer = ['front-lit', 'side-lit'];
        prefer.forEach(v => {
          const el = document.querySelector(`#lighting-directions input[value="${v}"]`);
          if (el) el.checked = true;
        });

        // if prefer didn't find at least 2, check any first two available
        const checkedNow = document.querySelectorAll('#lighting-directions input[type="checkbox"]:checked').length;
        if (checkedNow < 2) {
          const allLights = Array.from(document.querySelectorAll('#lighting-directions input[type="checkbox"]'));
          for (let i = 0; i < allLights.length && i < 2; i++) {
            allLights[i].checked = true;
          }
        }

        // set sliders to extremes to reflect sweep (sliders are still usable)
        document.getElementById('rotation-slider').value = 0;
        document.getElementById('tilt-slider').value = 0;
        document.getElementById('zoom-slider').value = 5;
      }

      // After forcing settings, refresh counts
      updateAngleSweepCount();
    }

    // Apply preset (uses camera-angles hidden block to remain compatible)
    function applyPreset() {
      const preset = document.getElementById('preset-select').value;
      if (!preset) return;

      // Reset all camera & lighting inputs (compat wrappers)
      document.querySelectorAll('#camera-angles input').forEach(cb => cb.checked = false);
      document.querySelectorAll('#lighting-directions input').forEach(cb => cb.checked = false);

      if (preset === 'product_photography') {
        ['eye-level', 'high-angle', 'overhead'].forEach(v => {
          const el = document.querySelector(`#camera-angles input[value="${v}"]`);
          if (el) el.checked = true;
        });
        const front = document.querySelector('#lighting-directions input[value="front-lit"]');
        if (front) front.checked = true;
      } else if (preset === 'lighting_study') {
        const el = document.querySelector('#camera-angles input[value="eye-level"]');
        if (el) el.checked = true;
        document.querySelectorAll('#lighting-directions input').forEach(cb => cb.checked = true);
      } else if (preset === 'multi_angle') {
        document.querySelectorAll('#camera-angles input').forEach(cb => cb.checked = true);
        const front = document.querySelector('#lighting-directions input[value="front-lit"]');
        if (front) front.checked = true;
      }

      updateAngleSweepCount();
    }

    // Helper: start over
    function startOver() {
      location.reload();
    }

    // tiny utility: sanitize filename
    function sanitizeFilename(name) {
      return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    }

    // Modal helpers (metadata)
    function viewMetadata() {
      const modal = document.getElementById('metadata-modal');
      const viewer = document.getElementById('metadata-viewer');

      const manifestData = {
        generated_at: new Date().toISOString(),
        total_variations: datasetResults.length,
        base_description: document.getElementById('object-description')?.value || '',
        variations: datasetResults.map(r => ({
          name: r.variation_name,
          seed: r.seed,
          modifications: r.modifications,
          image_url: r.image_url
        }))
      };

      viewer.textContent = JSON.stringify(manifestData, null, 2);
      modal.style.display = 'flex';
    }

    function closeMetadataModal() {
      document.getElementById('metadata-modal').style.display = 'none';
    }

    // Expose a couple functions globally that generator.js may call directly
    window.getCameraAngleFromRTZ = function (rotation, tilt) {
      // consistent with the generator helper used previously
      if (tilt <= -45) return 'overhead';
      if (tilt <= -30) return 'high-angle';
      if (tilt >= 30) return 'low-angle';
      if (rotation === 0 && tilt === 0) return 'eye-level';
      return 'eye-level';
    };

    window.getDistanceFromZoom = function (zoom) {
      if (zoom === 0) return 'close';
      if (zoom === 5) return 'mid';
      if (zoom === 10) return 'far';
      return 'mid';
    };
    // ------------------------------------------------------------
    // FIXED: Advanced Parameters Accordion Toggle (GLOBAL FUNCTION)
    // ------------------------------------------------------------
    window.toggleAdvancedParams = function () {
      const content = document.getElementById('advanced-params-content');
      const button = document.querySelector('.accordion-toggle');

      if (!content || !button) return;

      const isOpen = content.style.display === 'grid';

      if (isOpen) {
        content.style.display = 'none';
        button.classList.remove('active');
      } else {
        content.style.display = 'grid';
        button.classList.add('active');
      }
    };

  </script>
</body>

</html>